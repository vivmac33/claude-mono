# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MONOMORPH CI PIPELINE v1.6.1
# Runs on every PR and push to main
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BUILD & VALIDATE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install root dependencies
        run: npm ci --ignore-scripts

      - name: ğŸ“¦ Install web dependencies
        working-directory: apps/web
        run: npm install

      - name: ğŸ“¦ Install server dependencies
        working-directory: apps/server
        run: npm install

      - name: ğŸ” TypeScript Check (Web)
        working-directory: apps/web
        run: npx tsc --noEmit --skipLibCheck
        continue-on-error: true  # Don't fail build on TS errors for now

      - name: ğŸ—ï¸ Build Web App
        working-directory: apps/web
        run: npm run build
        env:
          # Suppress Vite warnings in CI
          CI: true

      - name: ğŸ“Š Build Output Stats
        run: |
          echo "### ğŸ“¦ Build Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "apps/web/dist" ]; then
            echo "**Web App Size:**" >> $GITHUB_STEP_SUMMARY
            du -sh apps/web/dist >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Asset Count:**" >> $GITHUB_STEP_SUMMARY
            find apps/web/dist -type f | wc -l >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: apps/web/dist
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # API HEALTH CHECK
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  health-check:
    name: API Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install server dependencies
        working-directory: apps/server
        run: npm install

      - name: âœ… Validate Environment Config
        working-directory: apps/server
        run: |
          echo "### âœ… Environment Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          node -e "require('./lib/env').validateEnv({ exitOnError: false, logWarnings: false })" && \
            echo "Environment config valid âœ“" >> $GITHUB_STEP_SUMMARY || \
            echo "Environment config has warnings (optional vars)" >> $GITHUB_STEP_SUMMARY

      - name: ğŸš€ Start API Server
        working-directory: apps/server
        run: |
          node server.js &
          echo $! > server.pid
          sleep 3  # Wait for server to start

      - name: ğŸ¥ Health Check
        run: |
          echo "### ğŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test health endpoint
          HEALTH_RESPONSE=$(curl -sf http://localhost:4000/api/v1/health)
          HEALTH_STATUS=$?
          
          if [ $HEALTH_STATUS -eq 0 ]; then
            echo "âœ… **Health endpoint:** Passed" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$HEALTH_RESPONSE" | jq '.' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Health endpoint:** Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Test ready endpoint
          READY_RESPONSE=$(curl -sf http://localhost:4000/api/v1/ready)
          if [ $? -eq 0 ]; then
            echo "âœ… **Ready endpoint:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Ready endpoint:** Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Test live endpoint
          LIVE_RESPONSE=$(curl -sf http://localhost:4000/api/v1/live)
          if [ $? -eq 0 ]; then
            echo "âœ… **Live endpoint:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Live endpoint:** Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Test docs endpoint
          DOCS_RESPONSE=$(curl -sf http://localhost:4000/docs)
          if [ $? -eq 0 ]; then
            echo "âœ… **Docs endpoint:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Docs endpoint:** Not available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All health checks passed! ğŸ‰" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ›‘ Stop API Server
        if: always()
        working-directory: apps/server
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) 2>/dev/null || true
            rm server.pid
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CI SUCCESS GATE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [build, health-check]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ Build job failed"
            exit 1
          fi
          if [ "${{ needs.health-check.result }}" != "success" ]; then
            echo "âŒ Health check job failed"
            exit 1
          fi
          echo "âœ… All CI checks passed!"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ Railway will auto-deploy on merge to main"
          echo "ğŸ“š API Docs: https://monomorphapi-production.up.railway.app/docs"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
